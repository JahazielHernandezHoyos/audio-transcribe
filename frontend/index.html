<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Transcribe - Transcripci√≥n en Tiempo Real</title>
    
    <!-- Google Fonts - Monospaced for Vim aesthetic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600&family=JetBrains+Mono:wght@300;400;500;600&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'code': ['Fira Code', 'JetBrains Mono', 'monospace'],
                        'mono': ['Roboto Mono', 'monospace'],
                    },
                    colors: {
                        vim: {
                            bg: '#002b36',        // Solarized Dark base03
                            surface: '#073642',   // Solarized Dark base02  
                            text: '#839496',      // Solarized Dark base0
                            bright: '#f8f8f2',   // Dracula foreground
                            comment: '#6272a4',   // Dracula comment
                            accent: '#8be9fd',    // Dracula cyan
                            blue: '#268bd2',      // Solarized blue
                            border: '#44475a',   // Dracula current line
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Terminal scanlines effect */
        .scanlines::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                transparent 50%, 
                rgba(0, 255, 0, 0.01) 51%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Glow effects */
        .glow-cyan {
            box-shadow: 0 0 20px rgba(139, 233, 253, 0.3);
            transition: all 0.2s ease;
        }
        
        .glow-cyan:hover {
            box-shadow: 0 0 30px rgba(139, 233, 253, 0.5);
        }
        
        .glow-blue {
            box-shadow: 0 0 20px rgba(38, 139, 210, 0.3);
            transition: all 0.2s ease;
        }
        
        .glow-blue:hover {
            box-shadow: 0 0 30px rgba(38, 139, 210, 0.5);
        }
        
        /* Pulse animation for status dots */
        @keyframes pulse-vim {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse-vim {
            animation: pulse-vim 2s infinite;
        }
        
        /* Progress animation */
        @keyframes progressIndeterminate {
            0% { left: -30%; width: 30%; }
            50% { left: 45%; width: 40%; }
            100% { left: 100%; width: 30%; }
        }
        
        .progress-indeterminate {
            animation: progressIndeterminate 1.4s ease-in-out infinite;
        }
        
        /* Custom scrollbar for transcript area */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(139, 233, 253, 0.1);
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(139, 233, 253, 0.3);
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-vim-bg text-vim-text font-mono min-h-screen scanlines relative">
    <!-- Header tipo barra de estado de Vim -->
    <header class="bg-vim-surface border-b border-vim-border font-code">
        <div class="max-w-6xl mx-auto px-4 py-2 flex items-center justify-between text-sm">
            <div class="flex items-center space-x-4">
                <span class="text-vim-accent">:transcribe</span>
                <span class="text-vim-comment">--INSERT--</span>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 rounded-full pulse-vim" id="statusDot" style="background-color: #ff6b6b;"></div>
                    <span id="statusText" class="text-vim-comment">Desconectado</span>
                </div>
                <span id="connectionStatus" class="text-vim-comment">Conectando...</span>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="max-w-6xl mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="font-code text-4xl md:text-6xl font-bold text-vim-bright mb-4">
                <span class="text-vim-accent">></span> Audio Transcribe
            </h1>
            <p class="font-mono text-lg text-vim-comment mb-6">
                Transcripci√≥n local en tiempo real con Whisper
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="startBtn" onclick="startCapture()" 
                        class="bg-green-600 hover:bg-green-700 text-white font-code px-8 py-3 rounded-md glow-cyan transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚ñ∂ Execute Capture
                </button>
                <button id="stopBtn" onclick="stopCapture()" disabled
                        class="bg-red-600 hover:bg-red-700 text-white font-code px-8 py-3 rounded-md transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚ñ† Stop Process
                </button>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="max-w-6xl mx-auto px-4 mb-8">
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Audio Devices Configuration Block -->
            <div class="bg-vim-surface border border-vim-border rounded-lg p-6">
                <h3 class="font-code text-lg text-vim-bright mb-4 flex items-center">
                    <span class="text-vim-accent mr-2">//</span> Audio Devices
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <label for="sourceKind" class="font-mono text-sm text-vim-comment block mb-1">source_type:</label>
                        <select id="sourceKind" class="w-full bg-vim-bg border border-vim-border rounded px-3 py-2 text-vim-text font-mono text-sm focus:border-vim-accent focus:outline-none">
                            <option value="input">microphone_input</option>
                            <option value="system">system_loopback</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="inputDevice" class="font-mono text-sm text-vim-comment block mb-1">input_device:</label>
                        <select id="inputDevice" class="w-full bg-vim-bg border border-vim-border rounded px-3 py-2 text-vim-text font-mono text-sm focus:border-vim-accent focus:outline-none"></select>
                    </div>
                    
                    <div>
                        <label for="outputDevice" class="font-mono text-sm text-vim-comment block mb-1">output_device:</label>
                        <select id="outputDevice" class="w-full bg-vim-bg border border-vim-border rounded px-3 py-2 text-vim-text font-mono text-sm focus:border-vim-accent focus:outline-none"></select>
                    </div>
                    
                    <button onclick="refreshDevices()" class="bg-vim-border hover:bg-vim-accent hover:text-vim-bg text-vim-accent font-mono px-4 py-2 rounded transition-colors duration-200">
                        refresh_devices()
                    </button>
                    
                    <div id="deviceStatus" class="font-mono text-xs text-vim-comment mt-2"></div>
                </div>
            </div>

            <!-- Whisper Model Configuration Block -->
            <div class="bg-vim-surface border border-vim-border rounded-lg p-6">
                <h3 class="font-code text-lg text-vim-bright mb-4 flex items-center">
                    <span class="text-vim-accent mr-2">//</span> Whisper Model
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <span class="font-mono text-sm text-vim-comment">current_model:</span>
                        <div id="currentModel" class="font-mono text-sm text-vim-text bg-vim-bg border border-vim-border rounded px-3 py-2 mt-1">Cargando...</div>
                    </div>
                    
                    <div>
                        <label for="languageSelect" class="font-mono text-sm text-vim-comment block mb-1">language:</label>
                        <select id="languageSelect" class="w-full bg-vim-bg border border-vim-border rounded px-3 py-2 text-vim-text font-mono text-sm focus:border-vim-accent focus:outline-none">
                            <option value="auto">auto_detect</option>
                            <option value="spanish" selected>es_ES</option>
                            <option value="english">en_US</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="showModelSelector()" class="bg-vim-blue hover:bg-blue-600 text-white font-mono px-4 py-2 rounded glow-blue transition-all duration-200">
                            change_model()
                        </button>
                        <button onclick="applyLanguage()" class="bg-vim-border hover:bg-vim-accent hover:text-vim-bg text-vim-accent font-mono px-4 py-2 rounded transition-colors duration-200">
                            apply_lang()
                        </button>
                    </div>
                    
                    <div class="flex space-x-4 text-xs">
                        <span id="modelStatus" class="font-mono text-vim-comment"></span>
                        <span id="languageStatus" class="font-mono text-vim-comment"></span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal selector de modelos -->
    <div id="modelModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="modelModalTitle">
        <div class="bg-vim-surface border border-vim-border rounded-lg max-w-4xl max-h-[80vh] w-full mx-4 flex flex-col overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-vim-border">
                <div>
                    <h3 id="modelModalTitle" class="font-code text-lg text-vim-bright">Select Whisper Model</h3>
                    <div id="modelModalHint" class="font-mono text-sm text-vim-comment">Choose balance between speed and accuracy</div>
                </div>
                <button onclick="closeModelSelector()" class="bg-vim-border hover:bg-red-600 text-vim-text hover:text-white px-3 py-1 rounded font-mono transition-colors duration-200">
                    [X]
                </button>
            </div>
            <div class="p-4 overflow-auto flex-1">
                <div id="modelsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div class="flex items-center justify-between p-4 border-t border-vim-border">
                <span id="modalInfo" class="font-mono text-sm text-vim-comment"></span>
                <button onclick="closeModelSelector()" class="bg-vim-border hover:bg-vim-accent hover:text-vim-bg text-vim-accent font-mono px-4 py-2 rounded transition-colors duration-200">
                    close()
                </button>
            </div>
        </div>
    </div>

    <!-- Editor/Transcription Section -->
    <section class="max-w-6xl mx-auto px-4 mb-8">
        <div class="bg-vim-surface border border-vim-border rounded-lg overflow-hidden">
            <!-- Editor Header -->
            <div class="bg-vim-bg border-b border-vim-border px-4 py-2 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="font-code text-sm text-vim-comment">~/transcripts/realtime.log</span>
                    <span class="font-mono text-xs text-vim-comment">--INSERT--</span>
                </div>
                <button onclick="clearTranscriptions()" class="bg-vim-border hover:bg-red-600 text-vim-text hover:text-white px-3 py-1 rounded font-mono text-xs transition-colors duration-200">
                    :clear
                </button>
            </div>
            
            <!-- Editor Content -->
            <div class="p-4">
                <div id="transcriptionText" class="bg-vim-bg border border-vim-border rounded p-4 min-h-[300px] max-h-[400px] overflow-y-auto custom-scrollbar font-mono text-sm">
                    <div class="text-vim-comment text-center pt-16">
                        <span class="text-vim-accent">></span> Press "Execute Capture" to start transcription...
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer tipo terminal -->
    <footer class="bg-vim-surface border-t border-vim-border mt-auto">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-center space-x-2 font-mono text-sm text-vim-comment">
                <span>--</span>
                <span>Local Whisper transcription</span>
                <span>‚Ä¢</span>
                <span>No data sent to external servers</span>
                <span>--</span>
            </div>
        </div>
    </footer>

    <script>
        // Estado de la aplicaci√≥n
        let isCapturing = false;
        let websocket = null;
        let transcriptions = [];
        
        // Referencias DOM
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const connectionStatus = document.getElementById('connectionStatus');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const transcriptionText = document.getElementById('transcriptionText');
        const inputDevice = document.getElementById('inputDevice');
        const outputDevice = document.getElementById('outputDevice');
        const deviceStatus = document.getElementById('deviceStatus');
        const sourceKind = document.getElementById('sourceKind');
        const modelModal = document.getElementById('modelModal');
        const modelsContainer = document.getElementById('modelsContainer');
        const modalInfo = document.getElementById('modalInfo');

        // Configuraci√≥n
        const API_BASE = 'http://127.0.0.1:8000';
        const WS_URL = 'ws://127.0.0.1:8000/ws';

        // Conectar WebSocket
        function connectWebSocket() {
            try {
                websocket = new WebSocket(WS_URL);
                
                websocket.onopen = function(event) {
                    console.log('WebSocket conectado');
                    updateConnectionStatus('connected', 'Conectado al servidor');
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                websocket.onclose = function(event) {
                    console.log('WebSocket cerrado');
                    updateConnectionStatus('disconnected', 'Desconectado');
                    
                    // Reconectar autom√°ticamente despu√©s de 3 segundos
                    setTimeout(connectWebSocket, 3000);
                };
                
                websocket.onerror = function(error) {
                    console.error('Error WebSocket:', error);
                    updateConnectionStatus('error', 'Error de conexi√≥n');
                };
                
            } catch (error) {
                console.error('Error conectando WebSocket:', error);
                updateConnectionStatus('error', 'Error de conexi√≥n');
                
                // Intentar reconectar
                setTimeout(connectWebSocket, 3000);
            }
        }

        // Manejar mensajes WebSocket
        function handleWebSocketMessage(data) {
            console.log('üì® Mensaje WebSocket recibido:', data);
            
            switch(data.type) {
                case 'status':
                    console.log('üìä Mensaje de status:', data.data);
                    if (data.data.is_capturing) {
                        updateCaptureStatus(true);
                    }
                    break;
                    
                case 'transcription':
                    console.log('üé§ Mensaje de transcripci√≥n:', data.data);
                    addTranscription(data.data);
                    break;
                    
                case 'response':
                    console.log('üí¨ Respuesta de comando:', data);
                    handleCommandResponse(data);
                    break;
                    
                default:
                    console.log('‚ùì Tipo de mensaje desconocido:', data.type);
            }
        }

        // Manejar respuestas de comandos
        function handleCommandResponse(data) {
            const { command, data: result } = data;
            
            if (command === 'start_capture') {
                if (result.success) {
                    updateCaptureStatus(true);
                } else {
                    alert('Error iniciando captura: ' + result.message);
                }
            } else if (command === 'stop_capture') {
                if (result.success) {
                    updateCaptureStatus(false);
                } else {
                    alert('Error deteniendo captura: ' + result.message);
                }
            }
        }

        // Actualizar estado de conexi√≥n
        function updateConnectionStatus(status, message) {
            statusDot.className = 'w-2 h-2 rounded-full pulse-vim';
            statusText.textContent = message;
            
            if (status === 'connected') {
                statusDot.style.backgroundColor = '#51cf66'; // green
                connectionStatus.textContent = 'Ready to transcribe';
                startBtn.disabled = false;
            } else if (status === 'capturing') {
                statusDot.style.backgroundColor = '#ffd43b'; // yellow
                connectionStatus.textContent = 'Capturing audio...';
            } else {
                statusDot.style.backgroundColor = '#ff6b6b'; // red
                connectionStatus.textContent = 'Reconnecting...';
                startBtn.disabled = true;
                stopBtn.disabled = true;
                updateCaptureStatus(false);
            }
        }

        // Actualizar estado de captura
        function updateCaptureStatus(capturing) {
            isCapturing = capturing;
            
            if (capturing) {
                updateConnectionStatus('capturing', 'Capturing audio...');
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    updateConnectionStatus('connected', 'Connected');
                    startBtn.disabled = false;
                }
                stopBtn.disabled = true;
            }
        }

        // Agregar transcripci√≥n
        function addTranscription(transcription) {
            console.log('üìù Nueva transcripci√≥n recibida:', transcription);
            
            if (!transcription.text || !transcription.text.trim()) {
                console.log('üîá Transcripci√≥n vac√≠a, ignorando');
                return;
            }
            
            transcriptions.push(transcription);
            
            const item = document.createElement('div');
            item.className = 'mb-4 p-3 bg-vim-surface border-l-4 border-vim-accent rounded-r-md';
            
            // Timestamp header
            const timestamp = document.createElement('div');
            timestamp.className = 'font-mono text-xs text-vim-comment mb-1';
            timestamp.textContent = `[${new Date().toLocaleTimeString()}]`;
            
            // Transcription text
            const text = document.createElement('div');
            text.className = 'font-mono text-vim-bright mb-2 leading-relaxed';
            text.textContent = transcription.text;
            
            // Metadata footer
            const meta = document.createElement('div');
            meta.className = 'font-mono text-xs text-vim-comment';
            
            const confidence = (transcription.confidence * 100).toFixed(0);
            const time = transcription.processing_time.toFixed(2);
            const model = transcription.model || 'unknown';
            const volume = transcription.volume ? transcription.volume.toFixed(3) : 'N/A';
            
            meta.innerHTML = `
                <span class="text-vim-accent">${model}</span> ‚Ä¢ 
                confidence: <span class="text-vim-text">${confidence}%</span> ‚Ä¢ 
                time: <span class="text-vim-text">${time}s</span> ‚Ä¢ 
                volume: <span class="text-vim-text">${volume}</span>
            `;
            
            item.appendChild(timestamp);
            item.appendChild(text);
            item.appendChild(meta);
            
            // Limpiar mensaje placeholder
            if (transcriptions.length === 1) {
                transcriptionText.innerHTML = '';
            }
            
            transcriptionText.appendChild(item);
            transcriptionText.scrollTop = transcriptionText.scrollHeight;
            
            // Animaci√≥n de entrada suave
            item.style.opacity = '0';
            item.style.transform = 'translateY(10px)';
            setTimeout(() => {
                item.style.transition = 'all 0.3s ease';
                item.style.opacity = '1';
                item.style.transform = 'translateY(0)';
            }, 10);
        }

        // Limpiar transcripciones
        function clearTranscriptions() {
            transcriptions = [];
            transcriptionText.innerHTML = `
                <div class="text-vim-comment text-center pt-16">
                    <span class="text-vim-accent">></span> Press "Execute Capture" to start transcription...
                </div>
            `;
        }

        // Iniciar captura
        function startCapture() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const selectedInput = inputDevice.value ? parseInt(inputDevice.value, 10) : null;
                const selectedOutput = outputDevice.value ? parseInt(outputDevice.value, 10) : null;
                const command = {
                    command: 'start_capture',
                    device_index: isNaN(selectedInput) ? null : selectedInput,
                    output_device_index: isNaN(selectedOutput) ? null : selectedOutput,
                    source: sourceKind.value,
                };
                websocket.send(JSON.stringify(command));
            } else {
                alert('WebSocket no conectado');
            }
        }

        // Detener captura
        function stopCapture() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const command = {
                    command: 'stop_capture'
                };
                websocket.send(JSON.stringify(command));
            } else {
                alert('WebSocket no conectado');
            }
        }

        // Funciones para gesti√≥n de modelos
        async function loadModelInfo() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                
                if (data.transcriber) {
                    const modelInfo = data.transcriber;
                    document.getElementById('currentModel').textContent = 
                        `${modelInfo.model_name || modelInfo.model_id || 'unknown'} (${modelInfo.device || 'unknown'})`;
                }
            } catch (error) {
                console.error('Error cargando info del modelo:', error);
            }
        }

        async function showModelSelector() {
            try {
                modalInfo.textContent = 'Cargando modelos...';
                openModelSelector();
                const response = await fetch(`${API_BASE}/models`);
                const models = await response.json();
                renderModels(models);
                modalInfo.textContent = 'Consejo: "tiny" es m√°s r√°pido; "large" es m√°s preciso.';
            } catch (error) {
                console.error('Error mostrando selector de modelos:', error);
                modalInfo.textContent = 'Error obteniendo lista de modelos';
            }
        }

        async function loadModel(modelId) {
            try {
                document.getElementById('modelStatus').textContent = 'Cargando...';
                
                const response = await fetch(`${API_BASE}/models/${modelId}/load`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('modelStatus').textContent = '‚úÖ Cargado';
                    setTimeout(() => {
                        document.getElementById('modelStatus').textContent = '';
                        loadModelInfo();
                        closeModelSelector();
                    }, 1200);
                } else {
                    document.getElementById('modelStatus').textContent = '‚ùå Error';
                    alert('Error cargando modelo: ' + result.message);
                }
                
            } catch (error) {
                console.error('Error cargando modelo:', error);
                document.getElementById('modelStatus').textContent = '‚ùå Error';
                alert('Error cargando modelo');
            }
        }

        async function applyLanguage() {
            try {
                const lang = document.getElementById('languageSelect').value;
                document.getElementById('languageStatus').textContent = 'Aplicando...';
                const response = await fetch(`${API_BASE}/models/tiny/load?language=${encodeURIComponent(lang)}`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('languageStatus').textContent = '‚úÖ Idioma aplicado';
                    setTimeout(() => { document.getElementById('languageStatus').textContent = ''; }, 2000);
                } else {
                    document.getElementById('languageStatus').textContent = '‚ùå Error';
                    alert('Error aplicando idioma: ' + (result.message || '')); 
                }
            } catch (e) {
                console.error('Error aplicando idioma', e);
                document.getElementById('languageStatus').textContent = '‚ùå Error';
            }
        }

        async function downloadModel(modelId, info) {
            try {
                modalInfo.textContent = `Descargando ${modelId}...`;
                const progressRow = document.createElement('div');
                progressRow.style.gridColumn = '1 / -1';
                progressRow.className = 'progress';
                const bar = document.createElement('span');
                progressRow.appendChild(bar);
                if (modelsContainer.firstChild) {
                    modelsContainer.firstChild.appendChild(progressRow);
                }
                const response = await fetch(`${API_BASE}/models/${modelId}/download`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    modalInfo.textContent = `‚úÖ Modelo ${modelId} descargado`;
                    const res2 = await fetch(`${API_BASE}/models`);
                    const models = await res2.json();
                    renderModels(models);
                } else {
                    modalInfo.textContent = '‚ùå Error descargando modelo';
                    alert(result.message || 'Error descargando modelo');
                }
            } catch (e) {
                console.error(e);
                modalInfo.textContent = '‚ùå Error de red en descarga';
            }
        }

        async function ensureLoadedThenActivate(modelId, info) {
            if (!info.downloaded) {
                await downloadModel(modelId, info);
                const res = await fetch(`${API_BASE}/models`);
                const models = await res.json();
                info = models[modelId] || info;
            }
            await loadModel(modelId);
        }

        function renderModels(models) {
            modelsContainer.innerHTML = '';
            const entries = Object.entries(models);
            entries.forEach(([id, info]) => {
                const card = document.createElement('div');
                card.className = 'bg-vim-bg border border-vim-border rounded-lg p-4 hover:border-vim-accent transition-colors duration-200';

                const header = document.createElement('div');
                header.className = 'flex items-center justify-between mb-2';
                
                const title = document.createElement('h5');
                title.className = 'font-code text-vim-bright';
                title.textContent = `${id.toUpperCase()}`;
                
                const statusDiv = document.createElement('div');
                statusDiv.className = 'flex space-x-2 text-xs';
                
                const sizeSpan = document.createElement('span');
                sizeSpan.className = 'text-vim-comment';
                sizeSpan.textContent = `${info.size_mb}MB`;
                statusDiv.appendChild(sizeSpan);
                
                const downloadSpan = document.createElement('span');
                downloadSpan.textContent = info.downloaded ? '‚úÖ' : 'üì•';
                statusDiv.appendChild(downloadSpan);
                
                if (info.is_current) {
                    const currentSpan = document.createElement('span');
                    currentSpan.className = 'text-vim-accent font-mono';
                    currentSpan.textContent = 'ACTIVE';
                    statusDiv.appendChild(currentSpan);
                }
                
                header.appendChild(title);
                header.appendChild(statusDiv);

                const desc = document.createElement('p');
                desc.className = 'font-mono text-sm text-vim-comment mb-3';
                desc.textContent = `${info.description} ‚Ä¢ ${info.recommended_for || ''}`;

                const footer = document.createElement('div');
                footer.className = 'flex items-center justify-between';
                
                const speedSpan = document.createElement('span');
                speedSpan.className = 'font-mono text-xs text-vim-comment';
                speedSpan.textContent = `${info.speed || 'medium'} speed`;
                
                const actionDiv = document.createElement('div');
                actionDiv.className = 'flex space-x-2';
                
                const loadBtn = document.createElement('button');
                loadBtn.className = `bg-vim-blue hover:bg-blue-600 text-white font-mono px-3 py-1 rounded text-xs transition-colors duration-200 ${info.is_current ? 'opacity-50 cursor-not-allowed' : ''}`;
                loadBtn.textContent = info.is_current ? 'active' : 'load()';
                loadBtn.onclick = async () => await ensureLoadedThenActivate(id, info);
                loadBtn.disabled = !!info.is_current;

                actionDiv.appendChild(loadBtn);
                
                if (!info.downloaded) {
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'bg-vim-border hover:bg-vim-accent hover:text-vim-bg text-vim-accent font-mono px-3 py-1 rounded text-xs transition-colors duration-200';
                    downloadBtn.textContent = 'download()';
                    downloadBtn.onclick = async () => await downloadModel(id, info);
                    actionDiv.appendChild(downloadBtn);
                }
                
                footer.appendChild(speedSpan);
                footer.appendChild(actionDiv);

                card.appendChild(header);
                card.appendChild(desc);
                card.appendChild(footer);
                modelsContainer.appendChild(card);
            });
        }

        function openModelSelector() {
            modelModal.classList.remove('hidden');
            modelModal.classList.add('flex');
            document.addEventListener('keydown', handleEscModal);
        }

        function closeModelSelector() {
            modelModal.classList.add('hidden');
            modelModal.classList.remove('flex');
            document.removeEventListener('keydown', handleEscModal);
        }

        function handleEscModal(ev) {
            if (ev.key === 'Escape') closeModelSelector();
        }

        // Inicializar aplicaci√≥n
        function init() {
            console.log('Iniciando Audio Transcribe Frontend...');
            updateConnectionStatus('disconnected', 'Conectando...');
            connectWebSocket();
            loadModelInfo();
            refreshDevices();
            modelModal.addEventListener('click', (ev) => {
                if (ev.target === modelModal) closeModelSelector();
            });
        }

        // Iniciar cuando la p√°gina est√© cargada
        document.addEventListener('DOMContentLoaded', init);

        // Limpiar al cerrar
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
        });

        // Dispositivos de audio
        async function refreshDevices() {
            try {
                deviceStatus.textContent = 'Cargando dispositivos...';
                const response = await fetch(`${API_BASE}/audio/devices`);
                const data = await response.json();

                // Poblar selects
                inputDevice.innerHTML = '';
                outputDevice.innerHTML = '';

                const makeOption = (d) => {
                    const opt = document.createElement('option');
                    opt.value = d.index;
                    const rate = d.default_sample_rate || d.default_samplerate || '';
                    const inCh = d.max_input_channels ?? d.maxInputChannels ?? 0;
                    opt.textContent = `${d.index}: ${d.name} ${inCh>0?'(in)':''} ${rate?`- ${Math.round(rate)}Hz`:''}`;
                    return opt;
                };

                if (Array.isArray(data.input_devices)) {
                    data.input_devices.forEach((d) => inputDevice.appendChild(makeOption(d)));
                }
                if (Array.isArray(data.output_devices)) {
                    data.output_devices.forEach((d) => outputDevice.appendChild(makeOption(d)));
                }

                deviceStatus.textContent = `Encontrados: ${data.input_devices?.length||0} entradas, ${data.output_devices?.length||0} salidas`;
            } catch (e) {
                console.error('Error cargando dispositivos', e);
                deviceStatus.textContent = 'Error cargando dispositivos';
            }
        }
    </script>
</body>
</html>