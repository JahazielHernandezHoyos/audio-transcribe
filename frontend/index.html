<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Transcribe - Transcripción en Tiempo Real</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6b6b;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #51cf66;
        }

        .status-dot.capturing {
            background: #ffd43b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Modal selector de modelos */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-backdrop.show {
            display: flex;
        }

        .modal-content {
            background: #1f1b2e;
            color: #fff;
            width: 860px;
            max-width: 95vw;
            max-height: 80vh;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.45);
            border: 1px solid rgba(255,255,255,0.12);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.2s ease;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 18px;
            background: rgba(255,255,255,0.06);
        }

        .modal-body {
            padding: 16px 18px 8px 18px;
            overflow: auto;
        }

        .modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            padding: 12px 18px 16px 18px;
            background: rgba(255,255,255,0.04);
        }

        .model-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .model-card {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 12px;
            padding: 14px;
            display: grid;
            grid-template-columns: 1fr auto;
            grid-template-rows: auto auto auto;
            gap: 6px 12px;
        }

        .model-card h5 {
            margin: 0;
            font-size: 1.05em;
            font-weight: 600;
        }

        .model-desc {
            grid-column: 1 / -1;
            opacity: 0.9;
            font-size: 0.92em;
        }

        .badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.14);
            font-size: 0.75em;
            opacity: 0.95;
        }

        .badge.success { background: rgba(20,170,90,0.18); border-color: rgba(20,170,90,0.35); }
        .badge.warn { background: rgba(255,180,0,0.18); border-color: rgba(255,180,0,0.35); }
        .badge.info { background: rgba(90,160,255,0.18); border-color: rgba(90,160,255,0.35); }

        .model-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ghost-btn {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.18);
            padding: 8px 12px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
        }

        .ghost-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress {
            position: relative;
            height: 8px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 999px;
            overflow: hidden;
        }

        .progress > span {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 30%;
            background: linear-gradient(90deg, #7aa2ff, #51cf66);
            animation: progressIndeterminate 1.4s ease-in-out infinite;
        }

        @keyframes progressIndeterminate {
            0% { left: -30%; width: 30%; }
            50% { left: 45%; width: 40%; }
            100% { left: 100%; width: 30%; }
        }

        @media (max-width: 700px) {
            .model-grid { grid-template-columns: 1fr; }
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .start-btn {
            background: linear-gradient(45deg, #51cf66, #40c057);
        }

        .stop-btn {
            background: linear-gradient(45deg, #ff6b6b, #fa5252);
        }

        .transcription-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            min-height: 300px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .transcription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .transcription-text {
            font-size: 1.1em;
            line-height: 1.6;
            max-height: 250px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .transcription-text::-webkit-scrollbar {
            width: 6px;
        }

        .transcription-text::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .transcription-text::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .transcript-item {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #51cf66;
        }

        .transcript-meta {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .clear-btn {
            padding: 8px 16px;
            font-size: 0.9em;
            background: rgba(255, 255, 255, 0.1);
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
            font-size: 0.9em;
        }

        .connection-status {
            font-size: 0.9em;
            opacity: 0.8;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2em;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            button {
                width: 100%;
                max-width: 200px;
            }

            .status-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 Audio Transcribe</h1>
        
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Desconectado</span>
            </div>
            <div class="connection-status" id="connectionStatus">
                Conectando...
            </div>
        </div>

            <div class="device-selector" style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
            <h4>🎚️ Dispositivos de Audio</h4>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; align-items: center;">
                <div>
                    <label for="sourceKind" style="font-size: 0.9em; opacity: 0.9;">Fuente</label><br/>
                    <select id="sourceKind" style="min-width: 220px; padding: 6px 10px; border-radius: 8px;">
                        <option value="input">Micrófono / Entrada</option>
                        <option value="system">Salida del sistema (loopback)</option>
                    </select>
                </div>
                <div>
                    <label for="inputDevice" style="font-size: 0.9em; opacity: 0.9;">Entrada</label><br/>
                    <select id="inputDevice" style="min-width: 260px; padding: 6px 10px; border-radius: 8px;"></select>
                </div>
                <div>
                    <label for="outputDevice" style="font-size: 0.9em; opacity: 0.9;">Salida (Windows)</label><br/>
                    <select id="outputDevice" style="min-width: 260px; padding: 6px 10px; border-radius: 8px;"></select>
                </div>
                <button id="refreshDevicesBtn" class="clear-btn" style="height: 36px;" onclick="refreshDevices()">🔄 Actualizar</button>
            </div>
            <div id="deviceStatus" style="margin-top: 8px; font-size: 0.85em; opacity: 0.8;"></div>
        </div>

        <div class="model-selector" style="background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
            <h4>🤖 Modelo Whisper Actual</h4>
            <div id="currentModel" style="font-size: 0.9em; opacity: 0.8;">Cargando...</div>
            <div style="margin-top: 10px;">
                <button onclick="showModelSelector()" style="padding: 8px 16px; font-size: 0.9em;">
                    🔧 Cambiar Modelo
                </button>
                <span id="modelStatus" style="margin-left: 10px; font-size: 0.8em;"></span>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <div>
                    <label for="languageSelect" style="font-size: 0.9em; opacity: 0.9;">Idioma</label><br/>
                    <select id="languageSelect" style="min-width: 220px; padding: 6px 10px; border-radius: 8px;">
                        <option value="auto">Auto</option>
                        <option value="spanish" selected>Español</option>
                        <option value="english">English</option>
                    </select>
                </div>
                <button class="clear-btn" style="height: 36px;" onclick="applyLanguage()">🌐 Aplicar idioma</button>
                <span id="languageStatus" style="font-size: 0.85em; opacity: 0.8;"></span>
            </div>
        </div>

        <!-- Modal selector de modelos -->
        <div id="modelModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modelModalTitle">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h3 id="modelModalTitle" style="font-weight:600;">Seleccionar modelo Whisper</h3>
                        <div id="modelModalHint" style="opacity:0.8; font-size:0.9em;">Elige el balance entre velocidad y precisión según tus recursos.</div>
                    </div>
                    <button class="ghost-btn" onclick="closeModelSelector()">✖</button>
                </div>
                <div class="modal-body">
                    <div id="modelsContainer" class="model-grid"></div>
                </div>
                <div class="modal-footer">
                    <span id="modalInfo" style="opacity:0.85; font-size:0.9em; margin-right:auto;"></span>
                    <button class="ghost-btn" onclick="closeModelSelector()">Cerrar</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn" class="start-btn" onclick="startCapture()">
                ▶️ Iniciar Captura
            </button>
            <button id="stopBtn" class="stop-btn" onclick="stopCapture()" disabled>
                ⏹️ Detener Captura
            </button>
        </div>

        <div class="transcription-area">
            <div class="transcription-header">
                <h3>📝 Transcripción en Tiempo Real</h3>
                <button class="clear-btn" onclick="clearTranscriptions()">
                    🗑️ Limpiar
                </button>
            </div>
            <div class="transcription-text" id="transcriptionText">
                <div style="opacity: 0.5; text-align: center; margin-top: 50px;">
                    Presiona "Iniciar Captura" para comenzar la transcripción...
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Transcripción local con Whisper • Sin envío de datos a servidores externos</p>
        </div>
    </div>

    <script>
        // Estado de la aplicación
        let isCapturing = false;
        let websocket = null;
        let transcriptions = [];
        
        // Referencias DOM
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const connectionStatus = document.getElementById('connectionStatus');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const transcriptionText = document.getElementById('transcriptionText');
        const inputDevice = document.getElementById('inputDevice');
        const outputDevice = document.getElementById('outputDevice');
        const deviceStatus = document.getElementById('deviceStatus');
        const sourceKind = document.getElementById('sourceKind');
        const modelModal = document.getElementById('modelModal');
        const modelsContainer = document.getElementById('modelsContainer');
        const modalInfo = document.getElementById('modalInfo');

        // Configuración
        const API_BASE = 'http://127.0.0.1:8000';
        const WS_URL = 'ws://127.0.0.1:8000/ws';

        // Conectar WebSocket
        function connectWebSocket() {
            try {
                websocket = new WebSocket(WS_URL);
                
                websocket.onopen = function(event) {
                    console.log('WebSocket conectado');
                    updateConnectionStatus('connected', 'Conectado al servidor');
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                websocket.onclose = function(event) {
                    console.log('WebSocket cerrado');
                    updateConnectionStatus('disconnected', 'Desconectado');
                    
                    // Reconectar automáticamente después de 3 segundos
                    setTimeout(connectWebSocket, 3000);
                };
                
                websocket.onerror = function(error) {
                    console.error('Error WebSocket:', error);
                    updateConnectionStatus('error', 'Error de conexión');
                };
                
            } catch (error) {
                console.error('Error conectando WebSocket:', error);
                updateConnectionStatus('error', 'Error de conexión');
                
                // Intentar reconectar
                setTimeout(connectWebSocket, 3000);
            }
        }

        // Manejar mensajes WebSocket
        function handleWebSocketMessage(data) {
            console.log('📨 Mensaje WebSocket recibido:', data);
            
            switch(data.type) {
                case 'status':
                    console.log('📊 Mensaje de status:', data.data);
                    if (data.data.is_capturing) {
                        updateCaptureStatus(true);
                    }
                    break;
                    
                case 'transcription':
                    console.log('🎤 Mensaje de transcripción:', data.data);
                    addTranscription(data.data);
                    break;
                    
                case 'response':
                    console.log('💬 Respuesta de comando:', data);
                    handleCommandResponse(data);
                    break;
                    
                default:
                    console.log('❓ Tipo de mensaje desconocido:', data.type);
            }
        }

        // Manejar respuestas de comandos
        function handleCommandResponse(data) {
            const { command, data: result } = data;
            
            if (command === 'start_capture') {
                if (result.success) {
                    updateCaptureStatus(true);
                } else {
                    alert('Error iniciando captura: ' + result.message);
                }
            } else if (command === 'stop_capture') {
                if (result.success) {
                    updateCaptureStatus(false);
                } else {
                    alert('Error deteniendo captura: ' + result.message);
                }
            }
        }

        // Actualizar estado de conexión
        function updateConnectionStatus(status, message) {
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = message;
            
            if (status === 'connected') {
                connectionStatus.textContent = 'Listo para transcribir';
                startBtn.disabled = false;
            } else {
                connectionStatus.textContent = 'Reconectando...';
                startBtn.disabled = true;
                stopBtn.disabled = true;
                updateCaptureStatus(false);
            }
        }

        // Actualizar estado de captura
        function updateCaptureStatus(capturing) {
            isCapturing = capturing;
            
            if (capturing) {
                statusDot.className = 'status-dot capturing';
                statusText.textContent = 'Capturando audio...';
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Listo para transcribir';
                    startBtn.disabled = false;
                }
                stopBtn.disabled = true;
            }
        }

        // Agregar transcripción
        function addTranscription(transcription) {
            console.log('📝 Nueva transcripción recibida:', transcription);
            
            if (!transcription.text || !transcription.text.trim()) {
                console.log('🔇 Transcripción vacía, ignorando');
                return;
            }
            
            transcriptions.push(transcription);
            
            const item = document.createElement('div');
            item.className = 'transcript-item';
            
            const meta = document.createElement('div');
            meta.className = 'transcript-meta';
            
            // Mostrar información más detallada
            const confidence = (transcription.confidence * 100).toFixed(0);
            const time = transcription.processing_time.toFixed(2);
            const model = transcription.model || 'unknown';
            const volume = transcription.volume ? transcription.volume.toFixed(3) : 'N/A';
            
            meta.textContent = `${model} • Conf: ${confidence}% • Tiempo: ${time}s • Vol: ${volume}`;
            
            const text = document.createElement('div');
            text.textContent = transcription.text;
            text.style.fontWeight = 'bold';
            text.style.fontSize = '1.1em';
            
            // Timestamp
            const timestamp = document.createElement('div');
            timestamp.className = 'transcript-meta';
            timestamp.textContent = new Date().toLocaleTimeString();
            timestamp.style.fontSize = '0.8em';
            timestamp.style.opacity = '0.6';
            
            item.appendChild(timestamp);
            item.appendChild(text);
            item.appendChild(meta);
            
            // Limpiar mensaje placeholder
            if (transcriptions.length === 1) {
                transcriptionText.innerHTML = '';
            }
            
            transcriptionText.appendChild(item);
            transcriptionText.scrollTop = transcriptionText.scrollHeight;
            
            // Animación de entrada
            item.style.animation = 'fadeIn 0.3s ease-in';
        }

        // Limpiar transcripciones
        function clearTranscriptions() {
            transcriptions = [];
            transcriptionText.innerHTML = `
                <div style="opacity: 0.5; text-align: center; margin-top: 50px;">
                    Presiona "Iniciar Captura" para comenzar la transcripción...
                </div>
            `;
        }

        // Iniciar captura
        function startCapture() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const selectedInput = inputDevice.value ? parseInt(inputDevice.value, 10) : null;
                const selectedOutput = outputDevice.value ? parseInt(outputDevice.value, 10) : null;
                const command = {
                    command: 'start_capture',
                    device_index: isNaN(selectedInput) ? null : selectedInput,
                    output_device_index: isNaN(selectedOutput) ? null : selectedOutput,
                    source: sourceKind.value,
                };
                websocket.send(JSON.stringify(command));
            } else {
                alert('WebSocket no conectado');
            }
        }

        // Detener captura
        function stopCapture() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const command = {
                    command: 'stop_capture'
                };
                websocket.send(JSON.stringify(command));
            } else {
                alert('WebSocket no conectado');
            }
        }

        // Funciones para gestión de modelos
        async function loadModelInfo() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                
                if (data.transcriber) {
                    const modelInfo = data.transcriber;
                    document.getElementById('currentModel').textContent = 
                        `${modelInfo.model_name || modelInfo.model_id || 'unknown'} (${modelInfo.device || 'unknown'})`;
                }
            } catch (error) {
                console.error('Error cargando info del modelo:', error);
            }
        }

        async function showModelSelector() {
            try {
                modalInfo.textContent = 'Cargando modelos...';
                openModelSelector();
                const response = await fetch(`${API_BASE}/models`);
                const models = await response.json();
                renderModels(models);
                modalInfo.textContent = 'Consejo: "tiny" es más rápido; "large" es más preciso.';
            } catch (error) {
                console.error('Error mostrando selector de modelos:', error);
                modalInfo.textContent = 'Error obteniendo lista de modelos';
            }
        }

        async function loadModel(modelId) {
            try {
                document.getElementById('modelStatus').textContent = 'Cargando...';
                
                const response = await fetch(`${API_BASE}/models/${modelId}/load`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('modelStatus').textContent = '✅ Cargado';
                    setTimeout(() => {
                        document.getElementById('modelStatus').textContent = '';
                        loadModelInfo();
                        closeModelSelector();
                    }, 1200);
                } else {
                    document.getElementById('modelStatus').textContent = '❌ Error';
                    alert('Error cargando modelo: ' + result.message);
                }
                
            } catch (error) {
                console.error('Error cargando modelo:', error);
                document.getElementById('modelStatus').textContent = '❌ Error';
                alert('Error cargando modelo');
            }
        }

        async function applyLanguage() {
            try {
                const lang = document.getElementById('languageSelect').value;
                document.getElementById('languageStatus').textContent = 'Aplicando...';
                const response = await fetch(`${API_BASE}/models/tiny/load?language=${encodeURIComponent(lang)}`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('languageStatus').textContent = '✅ Idioma aplicado';
                    setTimeout(() => { document.getElementById('languageStatus').textContent = ''; }, 2000);
                } else {
                    document.getElementById('languageStatus').textContent = '❌ Error';
                    alert('Error aplicando idioma: ' + (result.message || '')); 
                }
            } catch (e) {
                console.error('Error aplicando idioma', e);
                document.getElementById('languageStatus').textContent = '❌ Error';
            }
        }

        async function downloadModel(modelId, info) {
            try {
                modalInfo.textContent = `Descargando ${modelId}...`;
                const progressRow = document.createElement('div');
                progressRow.style.gridColumn = '1 / -1';
                progressRow.className = 'progress';
                const bar = document.createElement('span');
                progressRow.appendChild(bar);
                if (modelsContainer.firstChild) {
                    modelsContainer.firstChild.appendChild(progressRow);
                }
                const response = await fetch(`${API_BASE}/models/${modelId}/download`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    modalInfo.textContent = `✅ Modelo ${modelId} descargado`;
                    const res2 = await fetch(`${API_BASE}/models`);
                    const models = await res2.json();
                    renderModels(models);
                } else {
                    modalInfo.textContent = '❌ Error descargando modelo';
                    alert(result.message || 'Error descargando modelo');
                }
            } catch (e) {
                console.error(e);
                modalInfo.textContent = '❌ Error de red en descarga';
            }
        }

        async function ensureLoadedThenActivate(modelId, info) {
            if (!info.downloaded) {
                await downloadModel(modelId, info);
                const res = await fetch(`${API_BASE}/models`);
                const models = await res.json();
                info = models[modelId] || info;
            }
            await loadModel(modelId);
        }

        function renderModels(models) {
            modelsContainer.innerHTML = '';
            const entries = Object.entries(models);
            entries.forEach(([id, info]) => {
                const card = document.createElement('div');
                card.className = 'model-card';

                const title = document.createElement('h5');
                title.textContent = `${id.toUpperCase()} • ${info.size_mb}MB`;

                const badges = document.createElement('div');
                badges.className = 'badges';
                const b1 = document.createElement('span');
                b1.className = 'badge info';
                b1.textContent = `${info.speed || ''} speed`;
                const b2 = document.createElement('span');
                b2.className = 'badge info';
                b2.textContent = `${info.accuracy || ''} accuracy`;
                const b3 = document.createElement('span');
                b3.className = `badge ${info.is_current ? 'success' : ''}`;
                b3.textContent = info.is_current ? 'Actual' : (info.downloaded ? 'Descargado' : 'No descargado');
                const b4 = document.createElement('span');
                b4.className = 'badge';
                b4.textContent = `Descarga: ${info.estimated_download_time || '~'}`;
                badges.appendChild(b1); badges.appendChild(b2); badges.appendChild(b3); badges.appendChild(b4);

                const desc = document.createElement('div');
                desc.className = 'model-desc';
                desc.textContent = `${info.description} • ${info.recommended_for || ''}`;

                const actions = document.createElement('div');
                actions.className = 'model-actions';
                const loadBtn = document.createElement('button');
                loadBtn.className = 'ghost-btn';
                loadBtn.textContent = info.is_current ? 'En uso' : 'Cargar';
                loadBtn.disabled = !!info.is_current;
                loadBtn.onclick = async () => {
                    await ensureLoadedThenActivate(id, info);
                };

                const dlBtn = document.createElement('button');
                dlBtn.className = 'ghost-btn';
                dlBtn.textContent = info.downloaded ? 'Descargado' : 'Descargar';
                dlBtn.disabled = !!info.downloaded;
                dlBtn.onclick = async () => {
                    await downloadModel(id, info);
                };

                actions.appendChild(loadBtn);
                actions.appendChild(dlBtn);

                card.appendChild(title);
                card.appendChild(badges);
                card.appendChild(desc);
                card.appendChild(actions);
                modelsContainer.appendChild(card);
            });
        }

        function openModelSelector() {
            modelModal.classList.add('show');
            document.addEventListener('keydown', handleEscModal);
        }

        function closeModelSelector() {
            modelModal.classList.remove('show');
            document.removeEventListener('keydown', handleEscModal);
        }

        function handleEscModal(ev) {
            if (ev.key === 'Escape') closeModelSelector();
        }

        // Inicializar aplicación
        function init() {
            console.log('Iniciando Audio Transcribe Frontend...');
            updateConnectionStatus('disconnected', 'Conectando...');
            connectWebSocket();
            loadModelInfo();
            refreshDevices();
            modelModal.addEventListener('click', (ev) => {
                if (ev.target === modelModal) closeModelSelector();
            });
        }

        // Iniciar cuando la página esté cargada
        document.addEventListener('DOMContentLoaded', init);

        // Limpiar al cerrar
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
        });

        // Dispositivos de audio
        async function refreshDevices() {
            try {
                deviceStatus.textContent = 'Cargando dispositivos...';
                const response = await fetch(`${API_BASE}/audio/devices`);
                const data = await response.json();

                // Poblar selects
                inputDevice.innerHTML = '';
                outputDevice.innerHTML = '';

                const makeOption = (d) => {
                    const opt = document.createElement('option');
                    opt.value = d.index;
                    const rate = d.default_sample_rate || d.default_samplerate || '';
                    const inCh = d.max_input_channels ?? d.maxInputChannels ?? 0;
                    opt.textContent = `${d.index}: ${d.name} ${inCh>0?'(in)':''} ${rate?`- ${Math.round(rate)}Hz`:''}`;
                    return opt;
                };

                if (Array.isArray(data.input_devices)) {
                    data.input_devices.forEach((d) => inputDevice.appendChild(makeOption(d)));
                }
                if (Array.isArray(data.output_devices)) {
                    data.output_devices.forEach((d) => outputDevice.appendChild(makeOption(d)));
                }

                deviceStatus.textContent = `Encontrados: ${data.input_devices?.length||0} entradas, ${data.output_devices?.length||0} salidas`;
            } catch (e) {
                console.error('Error cargando dispositivos', e);
                deviceStatus.textContent = 'Error cargando dispositivos';
            }
        }
    </script>
</body>
</html>